# CI/CD Guide

## General Info

* A CI pipeline is setup in github [actions](https://github.com/tqjxlm/Sparkle/actions) at .github/workflows/ci.yml
* Pushing tags will generate releases on github. The release process is defined in .github/workflows/release.yml.
* All PRs are required to pass CI before merging.
* For now, there are a building test and a very basic functional test. Unit test, performance test and style check are coming soon.
* Archived builds will be uploaded on successful runs. You can download them from the [actions](https://github.com/tqjxlm/Sparkle/actions) page.
  * NOTICE: only download artifacts from workflow triggered by yourself. Security cannot be guaranteed for artifacts generated by untrusted developers.
  * NOTICE: due to certificate limitation, iOS artifacts cannot be installed on your machine. Please build with your own developer account to test them. Or you can ask me to register your device in my privsioning profile.

## Build Test

* Build test is run on every push and PR. It builds the project with different frameworks and pipelines.

## Functional Test

* Functional test is run on every push and PR. It runs the built app with different frameworks and pipelines, and compare the auto-generated screenshot with the ground truth.
* For now we only run functional test on macos and glfw framework without ray tracing mode. Other frameworks are coming soon. (I am looking for a provider to run CI on ios and android).
* On Windows, the functional test uses [Mesa lavapipe](https://github.com/pal1000/mesa-dist-win) (a software Vulkan driver) since GitHub Actions runners have no GPU.
* For now we only have ground truth for TestScene.
* Ground truth are updated manually for now. Please let me know if you want to update them.

### Test Command

```bash
# General usage (does not trigger build automatically)
python .\dev\functional_test.py --framework glfw --pipeline forward
```

```bash
# On Windows without a physical GPU (does not trigger build automatically)
python .\dev\functional_test.py --framework glfw --pipeline forward --software
```

### TestScene

| framework | cpu                                                                                             | gpu                                                                                             | forward                                                                                             | deferred                                                                                             |
| --------- | ----------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| glfw      | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_cpu_glfw.png)  | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_gpu_glfw.png)  | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_forward_glfw.png)  | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_deferred_glfw.png)  |
| macos     | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_cpu_macos.png) | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_gpu_macos.png) | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_forward_macos.png) | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_deferred_macos.png) |
| ios       | too slow to run                                                                                 | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_gpu_ios.png)   | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_forward_ios.png)   | [external](https://pub-70861c9d28254fff97386336cba96153.r2.dev/sparkle/TestScene_deferred_ios.png)   |
| android   | too slow to run                                                                                 | -                                                                                               | -                                                                                                   | -                                                                                                    |
